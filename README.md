# WASMD Blockchain Network Setup

## Быстрый старт для установки

1. **Клонирование репозитория с инструментами**
```bash
git clone https://github.com/kitay-sudo/wasmd-setup.git
cd wasmd-setup
```

2. **Подготовка конфигурации**
```bash
cp .env.example .env
nano .env  # Отредактируйте параметры под вашу сеть
```

3. **Запуск скрипта установки**
```bash
chmod +x wasmd-setup.sh
./wasmd-setup.sh
```

4. **Следуйте инструкциям скрипта**

## Интерактивное меню установки WASMD
```
+=========================================================+
|                  WASMD: Меню Установки                  |
+=========================================================+
| 1.  Клонировать репозиторий блокчейна                   |
| 2.  Установить зависимости для сборки                   |
| 3.  Установить Bech32-префикс                           |
| 4.  Собрать и установить wasmd                          |
| 5.  Инициализировать узел wasmd                         |
| 6.  Настроить конфигурацию wasmd                        |
| 7.  Создать ключ валидатора                             |
| 8.  Создать обычный кошелек                             |
| 9.  Добавить аккаунт в генезис                          |
| 10. Создать валидатора в генезисе                       |
| 11. Создать и собрать gentx                             |
| 12. Создать валидатора через JSON                       |
| 13. Показать ID ноды                                    |
| 14. Копировать genesis.json на другую ноду              |
| 15. Создать systemd-сервис и добавить в автозагрузку    |
| 16. Настроить файрвол (nftables) для защиты нод         |
| 17. Запустить ноду wasmd (foreground)                   |
| 18. Отправить монеты (tx bank send)                     |
| 19. Просмотреть логи                                    |
| 20. Резервное копирование файлов                        |
| 21. Проверить статус сервиса                            |
| 22. Тестовый запуск                                     |
| 23. Собрать ID нод для config.toml                      |
| 0.  Выйти                                               |
+=========================================================+
```

## Оглавление

1. [Введение](#введение)
2. [Требования](#требования)
3. [Быстрый старт](#быстрый-старт)
4. [Установка мастер-ноды (Master Node)](#установка-мастер-ноды-master-node)
5. [Установка валидатора (Validator Node)](#установка-валидатора-validator-node)
6. [Объединение и запуск сети](#объединение-и-запуск-сети)
7. [Меню скрипта](#меню-скрипта)
8. [Параметры .env.example](#параметры-envexample)
9. [Полезные команды](#полезные-команды)
10. [Безопасность сети](#безопасность-сети)
11. [Аудит и проверка подлинности](#аудит-и-проверка-подлинности)
12. [Контакты и поддержка](#контакты-и-поддержка)

---

## Введение

Этот репозиторий содержит автоматизированный скрипт для установки и настройки мастер-ноды и валидаторов блокчейна **wasmd**. Все параметры конфигурации выносены в файл `.env`, что обеспечивает гибкость и повторяемость развертывания.

## Требования

- Ubuntu 20.04/22.04 (или совместимая Linux-система)
- Права sudo
- Открытые необходимые порты (P2P, RPC, API, gRPC)
- Доступ к интернету

## Быстрый старт

Для начала работы следуйте инструкциям из раздела [Быстрый старт для установки](#быстрый-старт-для-установки) в начале документа.

**Важные замечания:**
- После копирования `.env.example` в `.env`, обязательно отредактируйте параметры под свою сеть.
- Обратите внимание на параметры `STAKE`, `CHAIN_ID` и `MONIKER` - они критически важны для корректной работы сети.
- Убедитесь, что у вас открыты все необходимые порты в файрволе (P2P, RPC, API, gRPC).

После запуска скрипта, следуйте пошаговому меню и выполняйте действия в правильной последовательности.

---

## Установка мастер-ноды (Master Node)

**1. Клонировать репозиторий блокчейна**  
Клонирует исходный код блокчейна wasmd:
```bash
git clone https://github.com/kitay-sudo/wasmd.git wasmd
```

**2. Установить зависимости для сборки**  
Устанавливает все необходимые пакеты и инструменты (Go, make, git, jq и др.) для сборки и работы wasmd.

**3. Установить Bech32-префикс**  
Позволяет задать уникальный Bech32-префикс для адресов вашей сети, изменяя Makefile. Это важно для идентификации адресов в вашей сети.

**4. Собрать и установить wasmd**  
Выполняет сборку исходного кода и установку бинарного файла wasmd.

**5. Инициализировать узел wasmd**  
Создаёт стандартные конфигурационные файлы, генерирует идентификатор ноды (Node ID) и необходимые ключи.
Автоматически очищает конфигурационные файлы от проблемных символов для предотвращения ошибок.

**6. Настроить конфигурацию wasmd**  
Вносит параметры из файла `.env` в конфигурационные файлы блокчейна. Все параметры подробно описаны в `.env.example`.

**7. Создать ключ валидатора**  
Создаёт кошелёк для валидатора мастер-ноды, генерирует адрес и ключ. Имя ключа вы задаёте вручную.

**8. Создать обычный кошелек**  
Создаёт обычный кошелек, который может использоваться для операций с монетами.

**9. Добавить аккаунт в генезис**  
Добавляет указанный аккаунт с заданным балансом в файл genesis.json. Необходим для распределения токенов при запуске сети.

**10. Создать валидатора в генезисе**  
Создает валидатора непосредственно в genesis-файле.

**11. Создать и собрать gentx**  
Создаёт специальную транзакцию (gentx) для валидатора и собирает все gentx в genesis-файл.  
Это необходимо для запуска сети с несколькими валидаторами.

---

## Объединение и запуск сети

1. **На мастер-ноде:**
   - Настройте конфигурацию (пункты 1-9 меню)
   - Получите ID ноды (пункт 13)
   - Передайте genesis.json на валидаторы (пункт 14)

2. **На нодах валидаторов:**
   - Настройте конфигурацию (пункты 1-6 меню)
   - Создайте кошелек (пункт 8)
   - Создайте валидатора (пункт 12)
   - Получите ID ноды (пункт 13)

3. **Настройка соединения между нодами:**
   - Используйте опцию 23 для сбора и форматирования ID нод
   - Добавьте ID и IP всех нод в секцию `persistent_peers` в формате `nodeid@ip:26656,nodeid2@ip2:26656`

4. **Настройка защиты периметра:**
   - На всех нодах запустите настройку файрвола (пункт 16)
   - Укажите IP-адреса всех нод и административный IP для SSH

5. **Запуск сервиса:**
   - На всех нодах создайте systemd-сервис (пункт 15)
   - Используйте меню (пункт 21) для проверки статуса
   - Для тестирования используйте "Тестовый запуск" (пункт 22)

6. **Работа с сетью:**
   - Отправка токенов между аккаунтами:
   ```bash
   wasmd tx bank send master fzp1v5czl6lwzg2wwmcnullxd232nn3l78r6shwhvn 3000000000ufzp \
     --from master \
     --chain-id fzp \
     --gas 90197 \
     --fees 5000ufzp \
     --broadcast-mode=sync \
     -y
   ```

   - Создание файла конфигурации валидатора (например, `val4.json`):
   ```json
   {
       "pubkey": {
          "@type":"/cosmos.crypto.ed25519.PubKey",
          "key":"A69bfl2pJi8RFeBlmRfyQ2FH8GryUBQ2DW2KKIx86xc="
       },
       "amount": "2000000000000ufzp",
       "moniker": "node002",
       "identity": "",
       "website": "",
       "security": "",
       "details": "",
       "commission-rate": "0.10",
       "commission-max-rate": "0.20",
       "commission-max-change-rate": "0.01",
       "min-self-delegation": "3"
   }
   ```

   - Создание валидатора из JSON-файла:
   ```bash
   wasmd tx staking create-validator val4.json \
     --from=validator2 \
     --chain-id=fzp \
     --fees=5000ufzp \
     --gas=auto \
     --gas-adjustment=1.3 \
     --broadcast-mode=sync \
     -y
   ```

   - Проверка списка валидаторов:
   ```bash
   wasmd q staking validators
   ```

   - Проверка информации о конкретном валидаторе:
   ```bash
   wasmd q staking validator $(wasmd keys show validator2 -a)
   ```

---

## Меню скрипта

Меню скрипта содержит все необходимые функции для установки, настройки и управления нодой wasmd:

- Клонирование и настройка репозитория
- Установка и компиляция wasmd
- Создание и управление ключами и кошельками
- Создание и настройка валидаторов
- Запуск и мониторинг ноды
- Отправка транзакций и управление токенами
- Утилиты для резервного копирования и безопасности

---

## Параметры .env.example

```ini
# Основные параметры сети
STAKE=ufzp                # Дефолтная единица стейкинга (деноминация)
CHAIN_ID=fzp-chain        # Идентификатор сети
MONIKER=master-node       # Имя вашей ноды
EXTERNAL_ADDR=1.2.3.4     # Внешний IP-адрес вашей ноды
TOKEN_DENOM=ufzp          # Дефолтная деноминация токена

# Параметры валидатора
MIN_SELF_DELEGATION=1     # Минимальная сумма делегирования для валидатора
COMMISSION_RATE=0.10      # Комиссия валидатора
COMMISSION_MAX_RATE=0.20  # Максимальная комиссия
COMMISSION_MAX_CHANGE_RATE=0.01 # Максимальное изменение комиссии

# Порты
P2P_PORT=26656            # P2P порт
RPC_PORT=26657            # RPC порт
API_PORT=1317             # API порт
GRPC_PORT=9090            # gRPC порт

# Параметры governance и экономики
MIN_DEPOSIT_AMOUNT=10000000   # Минимальный депозит для предложения
EXPEDITED_MIN_DEPOSIT_AMOUNT=50000000 # Для ускоренных предложений
CONSTANT_FEE_AMOUNT=1000      # Постоянная комиссия
MAX_VALIDATORS=100            # Максимум валидаторов
UNBONDING_TIME=1814400s       # Время анбонда
INFLATION=0.050000000000000000 # Начальная инфляция
ANNUAL_PROVISIONS=0.000000000000000000 # Годовые провизии
INFLATION_RATE_CHANGE=0.010000000000000000 # Изменение инфляции
INFLATION_MAX=0.015000000000000000 # Макс. инфляция
INFLATION_MIN=0.010000000000000000 # Мин. инфляция
GOAL_BONDED=0.670000000000000000 # Целевой процент стейкинга
BLOCKS_PER_YEAR=6311520       # Блоков в год
COMMUNITY_TAX=0.020000000000000000 # Комьюнити-такс
BASE_PROPOSER_REWARD=0.010000000000000000 # Базовая награда пропозеру
BONUS_PROPOSER_REWARD=0.040000000000000000 # Бонусная награда пропозеру
WITHDRAW_ADDR_ENABLED=true    # Включить вывод адреса

# Параметры слэшинга и безопасности
SLASH_FRACTION_DOUBLE_SIGN=0.006300000000000000 # Слэш за двойную подпись
SLASH_FRACTION_DOWNTIME=0.002100000000000000    # Слэш за даунтайм
DOWNTIME_JAIL_DURATION=600s     # Время в jail за даунтайм
SIGNED_BLOCKS_WINDOW=100        # Окно для подписанных блоков
MIN_SIGNED_PER_WINDOW=0.500000000000000000 # Мин. процент подписанных блоков

# Прочее
MINIMUM_GAS_PRICES=0.0001        # Минимальная цена газа
SEND_AMOUNT=100000000           # Сумма для отправки монет
GENTX_AMOUNT=1000000            # Сумма для gentx

# Настройки config.toml
RPC_LADDR="tcp://0.0.0.0:26657"  # Адрес RPC сервера

# Настройки API (app.toml)
API_ADDRESS="tcp://0.0.0.0:1317"  # Адрес API сервера
API_ENABLE=true                  # Включить API
API_SWAGGER=true                 # Включить Swagger
API_MAX_OPEN_CONNECTIONS=500     # Максимум открытых соединений
API_RPC_WRITE_TIMEOUT=15         # Таймаут записи RPC (сек)
API_ENABLED_UNSAFE_CORS=true     # Включить небезопасный CORS

# Настройки gRPC (app.toml)
GRPC_ADDRESS="0.0.0.0:9090"      # Адрес gRPC сервера
GRPC_ENABLE=true                 # Включить gRPC

# State Sync (app.toml)
STATE_SYNC_SNAPSHOT_INTERVAL=1000 # Интервал снапшотов для state sync

# WASM (app.toml)
WASM_ENABLE=true                 # Включить CosmWasm
WASM_CACHE_SIZE=200              # Размер кэша wasm
WASM_MEMORY_CACHE_SIZE=100       # Размер памяти кэша wasm
WASM_QUERY_GAS_LIMIT=3000000     # Лимит газа на запросы wasm
WASM_MAX_CONTRACT_SIZE=2000000   # Максимальный размер контракта wasm
WASM_MAX_CONTRACT_GAS=3000000    # Максимальный газ для контракта
WASM_MAX_CONTRACT_MSG_SIZE=1048576 # Максимальный размер сообщения
WASM_SIMULATION_GAS_LIMIT=3000000 # Лимит газа для симуляции
```

---

## Полезные команды

Проверить статус сервиса:
```bash
sudo systemctl status wasmd
```
Просмотреть логи:
```bash
journalctl -u wasmd -f
```
Проверить ID ноды:
```bash
wasmd tendermint show-node-id
```

---

## Безопасность сети

### Настройка файрвола с nftables

Для обеспечения безопасности блокчейн-сети, скрипт предоставляет возможность автоматической настройки файрвола с использованием nftables. Эта функция доступна через основное меню и выполняет следующие действия:

1. **Инсталляция nftables**:
```bash
   sudo apt update
   sudo apt install -y nftables
   ```

2. **Настройка правил доступа**:
   - Разрешает SSH-подключения только с указанного административного IP-адреса
   - Разрешает трафик между нодами блокчейна (по указанным IP-адресам)
   - Блокирует весь остальной входящий трафик
   - Логирует попытки несанкционированного доступа

3. **Активация правил**:
   ```bash
   sudo systemctl enable nftables
   sudo systemctl restart nftables
   ```

#### Как использовать:

1. Выберите пункт "Настроить файрвол (nftables)" в основном меню
2. Введите IP-адреса ваших нод (обычно 3 ноды)
3. Укажите IP-адрес, с которого разрешено администрирование по SSH
4. Скрипт настроит и активирует защиту

> **Внимание!** Эта функция применяет строгие правила файрвола. Убедитесь, что ввели правильный административный IP, иначе можете потерять доступ к серверу.

### Дополнительные возможности

Меню предоставляет ряд полезных функций для управления нодой:

1. **Просмотр логов:**
   Позволяет просмотреть последние записи в журнале системного сервиса wasmd
   
2. **Резервное копирование файлов:**
   Создает архив с критически важными файлами конфигурации и ключами (без приватных данных)
   
3. **Проверка статуса сервиса:**
   Отображает текущий статус systemd-сервиса и последние логи
   
4. **Тестовый запуск:**
   Запускает ноду в интерактивном режиме для отладки и тестирования

### Дополнительные меры безопасности

- Регулярно обновляйте сервер и программное обеспечение
- Используйте надежные пароли и ключи для SSH
- Настройте резервное копирование конфигурации через соответствующий пункт меню
- Регулярно проверяйте логи системы на предмет подозрительной активности

### Аудит кода

Все версии проекта поддерживают механизмы проверки целостности и неизменности кода через Git-хеши и подписи.

```bash
# Проверка хеша коммита
git rev-parse HEAD

# Сравнение с эталонным хешем
echo "ЭТАЛОННЫЙ_ХЕШ" | diff - <(git rev-parse HEAD)

# Если команда не вернула результат — хеш совпадает ✅
```

Подробная информация о процессе аудита и верификации доступна в документе [Аудит и проверка подлинности](docs/AUDIT.md).

---

## Аудит и проверка подлинности

Все версии проекта поддерживают механизмы проверки целостности и неизменности кода через Git-хеши и подписи.

### Как проверить подлинность кода

```bash
# Проверка хеша коммита
git rev-parse HEAD

# Сравнение с эталонным хешем
echo "ЭТАЛОННЫЙ_ХЕШ" | diff - <(git rev-parse HEAD)

# Если команда не вернула результат — хеш совпадает ✅
```

Подробная информация о процессе аудита и верификации доступна в документе [Аудит и проверка подлинности](docs/AUDIT.md).

---

## Контакты и поддержка

- [Официальный репозиторий wasmd](https://github.com/CosmWasm/wasmd)
- [Документация Cosmos SDK](https://docs.cosmos.network/)
- Вопросы и помощь: откройте issue или обратитесь к администратору сети.

---

> **Внимание:** Все параметры в `.env.example` — публичные и не содержат приватных данных.

---

## Лицензия и Авторские права

Данное программное обеспечение для настройки и развертывания блокчейна WASMD является проприетарным продуктом ООО "Финансы Застройки Производства" (ФЗП).

**ВАЖНОЕ ПРИМЕЧАНИЕ:** Данная лицензия распространяется ТОЛЬКО на скрипты настройки, утилиты и документацию, разработанные ООО "Финансы Застройки Производства". Сам блокчейн WASMD имеет собственную лицензию и не является предметом данного лицензионного соглашения.

**© 2025 ООО "Финансы Застройки Производства". Все права защищены.**

Использование, модификация, распространение и любые другие действия с этим программным обеспечением 
**разрешены только с письменного согласия правообладателя**.

Для получения разрешения на использование, пожалуйста, обратитесь по адресу: `license@fzp-blockchain.io`

Полный текст лицензии доступен в файле [LICENSE](LICENSE) этого репозитория.

Дополнительные материалы:
- [Политика безопасности](docs/SECURITY.md)
- [Руководство по внесению изменений](CONTRIBUTING.md)

## 🚨 ВАЖНО: Решение ошибки "validator set is empty"

Если вы получили ошибку:
```
failure when running app err="error during handshake: error on replay: validator set is empty after InitGenesis, please ensure at least one validator is initialized with a delegation greater than or equal to the DefaultPowerReduction"
```

**Причина:** В файле `genesis.json` отсутствуют валидаторы, поэтому нода не может запуститься.

**Решение:** Выполните диагностику (пункт 19) и создайте валидатора правильно.

## 📋 Порядок выполнения для SOLO ноды

### Первичная настройка (выполнить один раз):
1. **Клонировать репозиторий** - загружает исходный код
2. **Установить зависимости** - устанавливает Go, make, jq и другие требуемые пакеты
3. **Установить Bech32-префикс** - настраивает уникальный префикс для адресов
4. **Собрать и установить wasmd** - компилирует binary файл
5. **Инициализировать узел** - создает базовую структуру конфигурации
6. **Настроить конфигурацию** - настраивает genesis.json и другие параметры

### Создание валидатора (КРИТИЧЕСКИ ВАЖНО):
7. **Создать ключ валидатора** - генерирует криптографический ключ
8. **Создать обычный кошелек** - дополнительный кошелек (опционально)
9. **Добавить аккаунт в генезис** - добавляет баланс в genesis.json
10. **Создать валидатора в генезисе** - создает gentx и собирает их в genesis.json

### Запуск:
11. **Показать ID ноды** - получить идентификатор для подключения других нод
12. **Запустить ноду** - запуск в foreground режиме
13. **Создать systemd-сервис** - для автоматического запуска

## 📋 Порядок для СЕТИ из нескольких нод

### Мастер нода:
- Выполните пункты 1-13 (полная настройка solo ноды)
- Используйте пункт 14 для копирования genesis.json на другие ноды
- Соберите ID всех нод (пункт 17) и настройте persistent_peers

### Дополнительные ноды:
- Выполните пункты 1-6 (базовая настройка)
- Получите genesis.json от мастер ноды
- Используйте пункт 15 для подключения к сети как валидатор
- Настройте persistent_peers и запустите ноду

## 🛠️ Диагностика проблем

### Используйте пункт 19 "Диагностика ноды" для:
- Проверки наличия валидаторов в genesis.json
- Проверки конфигурационных файлов
- Проверки статуса ноды
- Получения рекомендаций по исправлению

### Используйте пункт 25 "Очистить конфигурацию" для:
- Полной очистки конфигурации wasmd
- Удаления всех файлов в ~/.wasmd
- Начала настройки с чистого листа

### Типичные проблемы:

1. **"validator set is empty"**
   - Причина: Не выполнены пункты 7-9-10
   - Решение: Создайте валидатора в правильном порядке

2. **Нода не запускается**
   - Проверьте логи (пункт 20)
   - Запустите диагностику (пункт 19)
   - Исправьте файлы конфигурации (пункт 24)

3. **Ошибки в genesis.json**
   - Используйте пункт 24 для исправления
   - Проверьте наличие валидаторов через диагностику
   - Для полной очистки используйте пункт 25

4. **Ошибка Bech32 префикса** ("expected wasm, got fzp")
   - Используйте пункт 26 для автоматического исправления
   - Выберите пересборку wasmd или переинициализацию

5. **Серьезные проблемы с конфигурацией**
   - Используйте пункт 25 для полной очистки
   - Затем выполните настройку заново (пункты 5-13)

## 📁 Структура файлов

```
wasmd-setup/
├── wasmd-setup.sh          # Основной скрипт
├── .env                    # Файл конфигурации (создается автоматически)
├── wasmd/                  # Клонированный репозиторий
└── ~/.wasmd/               # Конфигурация ноды
    ├── config/
    │   ├── genesis.json    # Состояние сети на старте
    │   ├── config.toml     # Конфигурация ноды
    │   └── app.toml        # Конфигурация приложения
    └── data/               # Данные блокчейна
```

## ⚙️ Важные параметры в .env

```bash
# Основные параметры
STAKE=ustake                    # Название токена
CHAIN_ID=local-chain           # ID сети
MONIKER=my-validator           # Имя ноды

# Порты
P2P_PORT=26656                 # P2P коммуникация
RPC_PORT=26657                 # RPC API
API_PORT=1317                  # REST API
GRPC_PORT=9090                 # gRPC API

# Экономические параметры
GENTX_AMOUNT=1000000ustake     # Сумма для стейкинга валидатора
MIN_SELF_DELEGATION=1000000    # Минимальное самоделегирование
MINIMUM_GAS_PRICES=0.0001      # Минимальная цена газа
```

## 🔧 Команды для ручного управления

### Проверка статуса:
```bash
wasmd status
wasmd tendermint show-node-id
wasmd keys list --keyring-backend os
```

### Работа с валидатором:
```bash
# Просмотр валидаторов
wasmd query staking validators

# Проверка баланса
wasmd query bank balances <address>

# Отправка токенов
wasmd tx bank send <from> <to> <amount>ustake --chain-id <chain-id>
```

### Работа с сервисом:
```bash
sudo systemctl status wasmd
sudo systemctl start wasmd
sudo systemctl stop wasmd
sudo journalctl -u wasmd -f
```

## 🔒 Безопасность

1. **Храните резервные копии ключей** (пункт 21)
2. **Настройте файрвол** (пункт 16)
3. **Регулярно проверяйте логи** (пункт 20)
4. **Используйте сильные пароли** для ключей

## 📞 Поддержка

При возникновении проблем:
1. Запустите диагностику (пункт 19)
2. Проверьте логи (пункт 20)
3. Используйте исправление файлов (пункт 24)
4. Изучите вывод команд для понимания ошибок

## 🔄 Обновление

Для обновления wasmd:
1. Остановите ноду
2. Сделайте резервную копию (пункт 21)
3. Выполните пункты 1 и 4 для обновления кода
4. Запустите ноду заново

---

**Автор:** Скрипт для автоматизации развертывания CosmWasm/wasmd блокчейна  
**Лицензия:** MIT
